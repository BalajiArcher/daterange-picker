<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="date-picker-calendar.html">
<link rel="import" href="date-picker-positioning.html"/>
<script src="../moment/min/moment.min.js"></script>

<!--
An element providing a solution to no problem in particular.

Example:

    <daterange-picker></daterange-picker>

@group daterange-picker
@element daterange-picker
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="daterange-picker">

  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
        position: relative;
      }

      input.date {
        position: relative;
        display: block;
        border: 1px solid #DDDDDD;
        background-color: #EEEEEE;
        color:#555555;
        min-width: 150px;
        padding: 8px 10px;
        margin: 10px;
        border-radius: 4px;
        text-align: center;
      }

      input.date:hover {
        cursor:pointer;
        border: 1px solid #44B4E4;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.075) inset, 0 0 8px rgba(102, 175, 233, 0.6);
      }

      date-picker-calendar {
        display: block;
        float: left;
      }

      #target {
        font-family: Arial;
        font-size: 14px;
        z-index: 1000;
      }

      /*.daterangepicker {*/
        /*display: inline-block;*/
        /*position: absolute;*/
        /*left: 70px;*/
      /*}*/

      .daterangepicker {
        /*background-color: #FFFFFF;*/
        display: inline-block;
        position: relative;
        left: 5px;
        top: 4px;
      }

      .daterangepicker:before {
        content: '';
        position: absolute;
        top: -2px;
        display: inline-block;
        border-right: 7px solid transparent;
        border-bottom: 7px solid #ccc;
        border-left: 7px solid transparent;
        border-bottom-color: rgba(0, 0, 0, 0.2);
      }

      .daterangepicker:after {
        position: absolute;
        top: -1px;
        display: inline-block;
        border-right: 6px solid transparent;
        border-bottom: 6px solid #fff;
        border-left: 6px solid transparent;
        content: '';
      }

      .daterangepicker.opensleft .ranges {
        float: right;
      }

      .daterangepicker.opensleft:before {
        right: 19px;
      }

      .daterangepicker.opensleft:after {
        right: 20px;
      }

      .daterangepicker.opensright .ranges {
        float: left;
      }

      .daterangepicker.opensright:before {
        left: 19px;
      }

      .daterangepicker.opensright:after {
        left: 20px;
      }

      .daterangepicker .ranges {
        width: 160px;
        padding: 8px;
        margin: 4px;
        border-radius: 4px;
        border: 1px solid rgba(0, 0, 0, 0.15);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.176);
      }

      .daterangepicker .ranges iron-selector {
        margin: 0;
        padding: 0;
        list-style-type: none;
      }

      .daterangepicker .ranges iron-selector div {
        padding: 5px 12px;
        margin-bottom: 8px;
        font-size: 13px;
        cursor: pointer;
        color: #0088CC;
        border-radius: 5px;
        background-color: #F5F5F5;
      }

      .daterangepicker .ranges iron-selector div.iron-selected, .daterangepicker .ranges iron-selector div:hover {
        background: #0088CC;
        color: #FFFFFF;
      }

    </style>
    <input id="triggerRange" value="{{selectedRange}}" on-click="toggle" class="date" readonly>
    <template is="dom-if" if="{{opened}}">
      <div id="targetShow" class="daterangepicker opensright">
          <div class="ranges">
            <iron-selector attr-for-selected="name" selected="{{selected}}">
              <div on-click="todayClicked" name="today">Today</div>
              <div on-click="yesterdayClicked" name="yesterday">Yesterday</div>
              <div on-click="last7DaysClicked" name="last7Days">Last 7 Days</div>
              <div on-click="last30DaysClicked" name="last30Days">Last 30 Days</div>
              <div on-click="thisMonthClicked" name="thisMonth">This Month</div>
              <div on-click="lastMonthClicked" name="lastMonth">Last Month</div>
              <div on-click="customClicked" name="custom">Custom</div>
            </iron-selector>
          </div>
          <template is="dom-if" if="{{showRanges}}">
            <date-picker-calendar start="start" start-date="{{startDate}}" end-date="{{endDate}}"></date-picker-calendar>
            <date-picker-calendar end="end" start-date="{{startDate}}" end-date="{{endDate}}"></date-picker-calendar>
          </template>
      </div>
    </template>
  </template>

</dom-module>

<script>

  Polymer({

    is: 'daterange-picker',

    properties: {
      halign: {
        type: String,
        value: 'right'
      },
      selected: {
        type: String,
        value: '',
        observer: '_selectionChanged'
      },
      selectedDate: {
        type: String,
        value: ''
      },
      startDate: {
        type: String,
        notify: true,
        reflectToAttribute: true,
        value: ''
      },
      endDate: {
        type: String,
        notify: true,
        reflectToAttribute: true,
        value: ''
      },
      opened: {
        type: Boolean,
        value: false,
        notify: true,
        observer: '_openedChanged'
      },
      relatedTarget: {
        type: Object,
        value: {}
      },
      showRanges: {
        type: Boolean,
        value: false
      },
      selectedRange: {
        type: String,
        computed: 'computeDateRange(startDate, endDate)'
      }
    },
    _selectionChanged: function(selected) {
      this.showRanges = false;
      if(selected === "custom") { this.showRanges = true; }
    },
    ready: function() {
      this.startDate = moment().subtract(30, "days").format("L");
      this.endDate = moment().format("L");
      this.selected = "last30Days";

      // positioning
      var self = this;
      window.addEventListener('scroll', function() {
        self.reposition();
      });
      window.addEventListener('resize', function() {
        self.reposition();
      });
      this.async(self.reposition);
    },
    computeDateRange: function(startDate, endDate) {
      return startDate + ' to ' + endDate;
    },
    todayClicked: function() {
      this.startDate = moment().format("L");
      this.endDate = moment().format("L");
      this.selected = "today";
      this.toggle();
    },
    yesterdayClicked: function() {
      this.startDate = moment().subtract(1, "days").format("L");
      this.endDate = moment().subtract(1, "days").format("L");
      this.selected = "yesterday";
      this.toggle();
    },
    last7DaysClicked: function() {
      this.startDate = moment().subtract(6, "days").format("L");
      this.endDate = moment().format("L");
      this.selected = "last7Days";
      this.toggle();
    },
    last30DaysClicked: function() {
      this.startDate = moment().subtract(30, "days").format("L");
      this.endDate = moment().format("L");
      this.selected = "last30Days";
      this.toggle();
    },
    thisMonthClicked: function() {
      this.startDate = moment().startOf('month').format("L");
      this.endDate = moment().endOf('month').format("L");
      this.selected = "thisMonth";
      this.toggle();
    },
    lastMonthClicked: function() {
      this.startDate = moment().subtract(1, "months").startOf('month').format("L");
      this.endDate = moment().subtract(1, "months").endOf('month').format("L");
      this.selected = "lastMonth";
      this.toggle();
    },
    customClicked: function() {
      this.selected = "custom";
    },


    _openedChanged: function(oldVal, newVal) {
      console.log('picker check');
      var picker = this;
      if (!this.clickListener) {
        this.clickListener = function(e) {
          var bound = picker.target.getBoundingClientRect();
          picker.async(function() {if (!picker.closeCanceled) picker.close(); else picker.closeCanceled = false});
        };
        this.targetClickListener = function(e) {
          picker.closeCanceled = true;
        }
      }

      if (newVal === "true") {
        this.reposition();
        this.style.display = "";
        this.async(function() {
          window.addEventListener('click', picker.clickListener, false);
          picker.target.addEventListener('click', picker.targetClickListener, false);
        }, 100);
      } else {
        window.removeEventListener('click', picker.clickListener, false);
        window.removeEventListener('click', picker.targetClickListener, false);
//        picker.style.display = "none";
      }
    },
    reposition: function() {
      console.log('reposition', this.opened);
      if (this.opened === "true") {
        var picker = this;
        var bound = this.relatedTarget.getBoundingClientRect();
        picker.style.position = "fixed";
        picker.style.top = (bound.bottom) + "px";
        if (this.halign === "right") picker.style.left = (bound.right) + "px";
        else if (this.halign === "left") picker.style.left = (bound.left) + "px";
        else picker.style.left = ((bound.left + bound.right) / 2) + "px";
      }
    },
    toggle: function() {
      if (this.opened === true) {
        this.opened = false;
      } else {
        this.opened = true;
      }
    },
    open: function() {
      this.opened = true;
    },
    close: function() {
      this.opened = false;
    }

  });

</script>
